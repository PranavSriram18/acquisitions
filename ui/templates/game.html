<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acquisitions Board Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #game-board {
            display: grid;
            gap: 2px;
            margin-bottom: 20px;
        }
        .cell {
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        select, button, input {
            margin: 10px 0;
            padding: 5px;
        }
        #game-info {
            margin-top: 20px;
            max-width: 600px;
            text-align: center;
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Acquisitions</h1>
    <div id="game-container">
        <div id="game-board"></div>
        <div id="game-info"></div>
        <div id="user-input"></div>
    </div>
    <script>
        let boardDimensions;
        let lastInputRequired = null;

        const socket = io()
        const gameId = "{{ game_id }}";
        const playerName = "{{ player_name }}";
        connected = false;

        socket.on('connect', () => {
            if (!connected) {
                connected = true;
                socket.emit('join', {game_id: gameId, player: playerName});
                // TODO get the player name from user input
                document.getElementById('game-info').innerHTML += '<br>Connected to server';
            }
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
        });

        socket.on('game_update', (data) => {
            console.log('Received game update: ', data)
            updateGameState(data);
        });

        function updateGameState(data) {
            console.log('In updateGameState');
            if (data.board_dimensions && !boardDimensions) {
                boardDimensions = data.board_dimensions;
                setupBoardCSS(boardDimensions);
            }
            if (data.board) {
                renderBoard(data.board);
            }
            updateMessages(data.messages);
            
            // TODO - Only update user input if it's different from last time
            console.log("Checking if input required...")
            if (data.type == 'input_required') {
                console.log("calling showUserInput")
                showUserInput(data);
                lastInputRequired = data;
            }
            console.log("Done")
        }

        function setupBoardCSS(dimensions) {
            const board = document.getElementById('game-board');
            board.style.gridTemplateColumns = `repeat(${dimensions.cols}, 60px)`;
            const cells = document.getElementsByClassName('cell');
            for (let cell of cells) {
                cell.style.width = '60px';
                cell.style.height = '60px';
            }
        }

        function renderBoard(boardData) {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            if (boardData) {
                for (let row of boardData) {
                    for (let cell of row) {
                        const cellElement = document.createElement('div');
                        cellElement.className = 'cell';
                        cellElement.textContent = cell.content;
                        if (cell.occupied) {
                            cellElement.style.backgroundColor = getHotelColor(cell.content);
                            cellElement.style.color = 'white';
                        } else if (cell.dead_zone) {
                            cellElement.style.backgroundColor = 'gray';
                        }
                        board.appendChild(cellElement);
                    }
                }
            }
        }

        function showUserInput(inputData) {
            console.log("In showUserInput");
            const userInputDiv = document.getElementById('user-input');
            let html = '';
            let currentValue = '';
            
            const existingSelect = document.getElementById('input-select');
            if (existingSelect) {
                currentValue = existingSelect.value;
            }

            if (inputData.input_type === 'tile') {
                html = `<p>${inputData.player}, select a tile:</p>
                        <select id="input-select">
                            ${inputData.available_tiles.map(tile => 
                                `<option value="${tile}" ${tile === currentValue ? 'selected' : ''}>${tile}</option>`
                            ).join('')}
                        </select>
                        <button id="submit-button">Submit</button>`;
            } else if (inputData.input_type === 'hotel') {
                html = `<p>${inputData.player}, select a hotel:</p>
                        <select id="input-select">
                            ${inputData.available_hotels.map(hotel => 
                                `<option value="${hotel}" ${hotel === currentValue ? 'selected' : ''}>${hotel}</option>`
                            ).join('')}
                        </select>
                        <button id="submit-button">Submit</button>`;
            } else if (inputData.input_type === 'buy_order') {
                html = `<p>${inputData.player}, enter buy order:</p>
                        <form id="buy-order-form">
                            ${inputData.available_hotels.map(hotel => {
                                const currentValue = document.getElementById(`${hotel}-input`) ? 
                                    document.getElementById(`${hotel}-input`).value : '0';
                                return `<label>${hotel}: <input type="number" id="${hotel}-input" name="${hotel}" min="0" value="${currentValue}"></label><br>`;
                            }).join('')}
                            <button type="button" id="submit-button">Submit</button>
                        </form>`;
            } else if (inputData.input_type === 'liquidation') {
                html = `<p>${inputData.player}, enter liquidation options for ${inputData.num_shares} shares:</p>
                        <form id="liquidation-form">
                            <label>Sell: <input type="number" id="sell-input" name="sell" min="0" max="${inputData.num_shares}" value="0"></label><br>
                            <label>Twofer: <input type="number" id="twofer-input" name="twofer" min="0" max="${Math.floor(inputData.num_shares/2)}" value="0"></label><br>
                            <button type="button" id="submit-button">Submit</button>
                        </form>`;
            }
            userInputDiv.innerHTML = html;
            console.log("Generated HTML:", html);

            document.getElementById('submit-button').addEventListener('click', function() {
                submitInput(inputData.input_type);
            });

            lastInputRequired = inputData;
        }

        function submitInput(type) {
            let data = {};
            
            if (type === 'tile' || type === 'hotel') {
                const select = document.getElementById('input-select');
                if (!select) {
                    console.error('Select element not found for ' + type);
                    return;
                }
                console.log("Selected value:", select.value);
                console.log("All options:", Array.from(select.options).map(opt => opt.value));
                data[type] = select.value;
            } else if (type === 'buy_order') {
                const form = document.getElementById('buy-order-form');
                if (!form) {
                    console.error('Buy order form not found');
                    return;
                }
                data.buy_order = {};
                for (let input of form.elements) {
                    if (input.type === 'number') {
                        data.buy_order[input.name] = parseInt(input.value) || 0;
                    }
                }
            } else if (type === 'liquidation') {
                const form = document.getElementById('liquidation-form');
                if (!form) {
                    console.error('Liquidation form not found');
                    return;
                }
                const sellInput = form.elements['sell'];
                const twoferInput = form.elements['twofer'];
                if (!sellInput || !twoferInput) {
                    console.error('Liquidation inputs not found');
                    return;
                }
                data.sell = parseInt(sellInput.value) || 0;
                data.twofer = parseInt(twoferInput.value) || 0;
            } else {
                console.error('Unknown input type: ' + type);
                return;
            }

            console.log('Submitting data:', data);

            socket.emit('make_move', {game_id: gameId, move: data});

            document.getElementById('user-input').innerHTML = '';
            lastInputRequired = null;  // Reset lastInputRequired
        }

        function getHotelColor(hotel) {
            const colors = {
                'CO': 'lightblue',
                'IM': 'lightpink',
                'AM': 'navy',
                'FE': 'lightgreen',
                'WO': 'brown',
                'LE': 'deeppink',
                'TO': 'tan'
            };
            return colors[hotel] || 'white';
        }

        function updateMessages(messages) {
            if (!Array.isArray(messages)) return;
            document.getElementById('game-info').innerHTML = messages.join('<br>');
        }
    </script>
</body>
</html>